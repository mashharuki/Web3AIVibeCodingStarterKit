# AMM DEX 要件定義書

## 概要

Ethereum Sepolia テストネットワーク上で動作する自動マーケットメーカー（AMM）型分散型取引所（DEX）を開発します。Uniswap V2 のコア機能を参考に、流動性プール管理とトークンスワップ機能を提供する検証用DEXです。

対象トークン：

- USDC: 0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238
- JPYC: 0x431D5dfF03120AFA4bDf332c61A6e1766eF37BDB
- PYUSD: 0xCaC524BcA292aaade2DF8A05cC58F0a65B1B3bB9

## 必要な画面一覧

1. **ホーム/スワップ画面** - メインのトークン交換インターフェース
2. **流動性プール画面** - 流動性の追加・削除管理
3. **プール詳細画面** - 個別プールの詳細情報と統計

## 共通コンポーネント

- **ヘッダーコンポーネント** - 全画面共通のナビゲーションとウォレット接続ボタン

## 必要な機能一覧

### コア機能

- トークンスワップ（自動価格計算）
- 流動性プール作成・管理
- 流動性提供・削除
- リアルタイム価格表示
- ウォレット接続・管理

### 補助機能

- スリッページ設定
- 取引履歴表示
- プール統計情報
- トランザクション状態管理

## 採用技術スタック

### フロントエンド

- **フレームワーク**: Next.js 14 (App Router)
- **言語**: TypeScript
- **スタイリング**: TailwindCSS + Shadcn/UI
- **Web3ライブラリ**: wagmi + viem + RainbowKit
- **状態管理**: React useState/useContext

### スマートコントラクト

- **言語**: Solidity ^0.8.19
- **開発環境**: Hardhat
- **ライブラリ**: OpenZeppelin Contracts
- **テスト**: Mocha/Chai + TypeScript

### インフラ

- **ネットワーク**: Ethereum Sepolia (Chain ID: 11155111)
- **パッケージマネージャー**: pnpm
- **フォーマッター**: Prettier

## 要件

### 要件1: トークンスワップ機能

**ユーザーストーリー:** トレーダーとして、サポートされているERC20トークン間で効率的に交換を行いたい。手数料と価格影響を事前に確認し、適切なスリッページ設定で安全に取引したい。

#### 受け入れ基準

1. WHEN ユーザーがスワップ画面でトークンペアを選択 THEN システム SHALL 現在の交換レートと推定ガス料金を表示する
2. WHEN ユーザーが交換数量を入力 THEN システム SHALL リアルタイムで受け取り予定数量と価格影響を計算して表示する
3. WHEN ユーザーがスリッページ許容値を設定 THEN システム SHALL 0.1%から50%の範囲で設定を受け付ける
4. WHEN ユーザーがスワップを実行 THEN システム SHALL MetaMaskでトランザクション署名を要求する
5. IF 流動性が不足している場合 THEN システム SHALL エラーメッセージを表示してトランザクションを防止する
6. WHEN トランザクションが完了 THEN システム SHALL 成功通知と取引詳細を表示する

### 要件2: 流動性プール管理

**ユーザーストーリー:** 流動性プロバイダーとして、トークンペアに流動性を提供し、取引手数料から報酬を得たい。また、必要に応じて流動性を引き出したい。

#### 受け入れ基準

1. WHEN ユーザーが流動性追加画面でトークンペアを選択 THEN システム SHALL 現在のプール比率と必要な各トークン数量を表示する
2. WHEN ユーザーが一方のトークン数量を入力 THEN システム SHALL 自動的にもう一方のトークン数量を現在の比率に基づいて計算する
3. WHEN ユーザーが流動性を追加 THEN システム SHALL LPトークンを発行してユーザーのウォレットに送信する
4. WHEN ユーザーが流動性削除を選択 THEN システム SHALL 保有するLPトークンの割合に応じた各トークンの受け取り予定数量を表示する
5. IF 新しいトークンペアの場合 THEN システム SHALL 初期流動性プロバイダーが初期価格を設定できるようにする
6. WHEN 流動性が追加または削除される THEN システム SHALL プール統計情報をリアルタイムで更新する

### 要件3: ウォレット接続とアカウント管理

**ユーザーストーリー:** ユーザーとして、全画面共通のヘッダーからMetaMaskウォレットを安全に接続し、自分のアカウント情報を確認したい。

#### 受け入れ基準

1. WHEN ユーザーがヘッダーのConnectWalletボタンをクリック THEN システム SHALL MetaMask接続ダイアログを表示する
2. WHEN ウォレットが接続される THEN システム SHALL ヘッダーにユーザーのアドレス（短縮形）とアカウントドロップダウンを表示する
3. IF ユーザーが異なるネットワークに接続している場合 THEN システム SHALL Sepoliaネットワークへの切り替えを促すモーダルを表示する
4. WHEN ウォレットが接続されている THEN システム SHALL アカウントドロップダウンでサポートされている全トークンの残高を表示する
5. WHEN ユーザーがアカウントドロップダウンを開く THEN システム SHALL 過去の取引履歴とLPトークン保有状況を表示する
6. WHEN ウォレット接続が切断される THEN システム SHALL ヘッダーを未接続状態に戻し、全ての残高情報をクリアする

### 要件4: 価格表示とプール情報

**ユーザーストーリー:** ユーザーとして、各トークンペアの現在価格、流動性、取引量などの市場情報をリアルタイムで確認したい。

#### 受け入れ基準

1. WHEN ユーザーがプール一覧を表示 THEN システム SHALL 全てのアクティブなプールの基本情報を表示する
2. WHEN ユーザーが特定のプールを選択 THEN システム SHALL 詳細な統計情報（TVL、24時間取引量、手数料収益）を表示する
3. WHEN 新しい取引が発生 THEN システム SHALL 価格とプール情報を自動的に更新する
4. WHEN ユーザーがプール詳細画面を表示 THEN システム SHALL 過去24時間の価格チャートを表示する
5. IF プールが存在しない場合 THEN システム SHALL 「プールが見つかりません」メッセージを表示する
6. WHEN ページを読み込み THEN システム SHALL 全てのプール情報を3秒以内に表示する

### 要件5: エラーハンドリングとユーザビリティ

**ユーザーストーリー:** ユーザーとして、取引中にエラーが発生した場合、明確な説明と解決方法を知りたい。また、取引の進行状況を常に把握したい。

#### 受け入れ基準

1. WHEN トランザクションが失敗 THEN システム SHALL 具体的なエラー理由と推奨される解決方法を表示する
2. WHEN トランザクションが進行中 THEN システム SHALL ローディング状態と推定完了時間を表示する
3. IF ガス料金が不足している場合 THEN システム SHALL 必要なETH数量を明示してエラーメッセージを表示する
4. WHEN ネットワークエラーが発生 THEN システム SHALL 自動的に再試行し、3回失敗後にエラーメッセージを表示する
5. IF トークン承認が必要な場合 THEN システム SHALL 承認トランザクションを先に実行するよう案内する
6. WHEN 大きな価格影響が予想される THEN システム SHALL 警告メッセージと確認ダイアログを表示する
