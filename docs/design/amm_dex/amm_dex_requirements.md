# AMM DEX 要件定義書

## 1. はじめに

### 1.1. プロジェクト概要

本プロジェクトは、Uniswapに類似した自動マーケットメーカー（AMM）方式の分散型取引所（DEX）を開発することを目的とします。
このDEXは学習と検証を目的としており、EthereumのSepoliaテストネットワーク上で動作します。

参考プロジェクトとして、UNCHAINの学習コンテンツである [AVAX-AMM](https://github.com/unchain-tech/AVAX-AMM) をベンチマークとし、同等の完成度を目指します。

### 1.2. プロジェクトのゴール

- ユーザーが2種類のトークンをスワップできる機能を提供する。
- ユーザーが流動性プールに資産を提供し、その見返りとしてLPトークンを受け取れる機能を提供する。
- ユーザーが提供した流動性を引き出すことができる機能を提供する。
- 上記機能を、安全でガス効率の良いスマートコントラクトと、直感的に操作できるフロントエンドで実現する。
- セキュリティに関して、既知のリエントランシー攻撃に対する対策を講じる。

## 2. 必要な画面一覧

ユーザーがDEXを利用するために、以下の画面を構築します。

| 画面名 | 概要 |
| :--- | :--- |
| **スワップ画面** | ユーザーがトークンを交換するためのメイン画面。交換元と交換先のトークンおよび数量を選択し、スワップを実行する。 |
| **流動性提供画面** | ユーザーが流動性プールにトークンペアを預け入れるための画面。預け入れるトークンペアと数量を選択し、流動性を提供する。 |
| **流動性削除画面** | ユーザーが提供した流動性を引き出すための画面。保有するLPトークンの量に応じて、預け入れたトークンペアを引き出す。 |
| **自分の流動性ポジション表示画面** | ユーザーがどのプールに、どれだけのトークンペアとLPトークンを保有しているかを一覧で確認できる画面。 |
| **共通コンポーネント** | 全ての画面で共通して利用されるUIコンポーネント。 |
| - ウォレット接続ボタン | ユーザーが自身のウォレット（MetaMaskなど）をアプリケーションに接続するためのボタン。 |
| - ヘッダー | 各画面へのナビゲーションリンクやウォレット接続ボタンを配置する。 |
| - トランザクション通知 | トランザクションの実行状況（保留中、成功、失敗）をユーザーに通知する。 |

## 3. 必要な機能一覧

本DEXを実現するために必要な機能を、フロントエンドとスマートコントラクトに分けて定義します。

### 3.1. フロントエンド機能

| 機能名 | 概要 |
| :--- | :--- |
| **ウォレット接続** | wagmiとRainbowKitを使用し、ユーザーがMetaMaskなどのウォレットを接続できるようにする。接続状態やアカウント情報、ネットワーク情報を管理する。 |
| **トークンスワップ** | ユーザーが指定したトークンと数量でスワップを実行する。入力値の検証、スリッページ設定、最適な交換レートの計算、トランザクションの送信を行う。 |
| **流動性提供** | ユーザーが選択したトークンペアと数量で流動性を提供する。提供量に応じてもらえるLPトークン量を算出し、トランザクションを送信する。 |
| **流動性削除** | ユーザーが保有するLPトークンを指定して流動性を削除する。引き出せるトークンペアの数量を算出し、トランザクションを送信する。 |
| **自分の流動性ポジション表示** | ユーザーが提供中の流動性（トークンペア、LPトークン量）をプールごとに一覧表示する。 |
| **残高表示** | 接続中のウォレットが保有する各トークンの残高を表示する。 |
| **価格・レート表示** | 選択されたトークンペアの交換レートや、流動性プールにおけるトークンの預け入れ比率を表示する。 |
| **ERC20トークン対話** | ユーザーがトークンのApprove（DEXコントラクトによるトークン操作の許可）を行えるようにする。 |

### 3.2. スマートコントラクト機能

| コントラクト | 機能名/イベント | 概要 |
| :--- | :--- | :--- |
| **AMMコントラクト** | `swap` | ユーザーからの要求に基づき、2つのトークンを交換する。その際、0.3%の取引手数料を徴収し、流動性提供者に還元する仕組みを実装する。 |
| | `addLiquidity` | ユーザーからトークンペアを受け取り、流動性プールに追加する。対価としてLPトークンをミントし、ユーザーに送付する。 |
| | `removeLiquidity` | ユーザーからLPトークンを受け取り、バーンする。対価として、LPトークンの量に応じたトークンペアをユーザーに返却する。 |
| | `getReserves` | 流動性プールに存在する各トークンの量を返す。 |
| | `getAmountOut` | 入力トークン量に対して、交換後に得られる出力トークン量を計算して返す。 |
| | **Event:** `Swap` | `(sender, amount0In, amount1In, amount0Out, amount1Out, to)` スワップ発生時に放出されるイベント。 |
| | **Event:** `Mint` | `(sender, amount0, amount1)` 流動性提供（LPトークン発行）時に放出されるイベント。 |
| | **Event:** `Burn` | `(sender, amount0, amount1, to)` 流動性削除（LPトークン償却）時に放出されるイベント。 |
| **ERC20トークン** | (標準機能) | `TokenA (TKA)` と `TokenB (TKB)` の2種類のERC20トークンをデプロイする。 |
| | `faucet` | 誰でも無料で一定量のテストトークンを入手できるようにするフォーセット機能。1ウォレットあたり1日1回、各トークンを100ずつ取得できる仕様とする。 |
| **LPトークン** | (標準機能) | 流動性提供の証明となるERC20準拠のLPトークン。`addLiquidity`時にミントされ、`removeLiquidity`時にバーンされる。 |

## 4. デザイン要件

- **UI/UXデザイン:** 全体として、Uniswapのようなモダンで、シンプルかつ直感的に操作できるデザインを目指します。クリーンなレイアウト、分かりやすい配色、スムーズなアニメーションを取り入れ、ユーザー体験を向上させます。

## 5. 採用する技術スタック

本プロジェクトでは、`copilot-instructions.md`および各パッケージの`instructions.md`で定義されたルールに基づき、以下の技術スタックを採用します。

### 5.1. 共通

| 技術 | 概要 | バージョン |
| :--- | :--- | :--- |
| **pnpm** | パッケージマネージャー。monorepo構成の管理に使用する。 | 最新版 |
| **TypeScript** | 静的型付け言語。コードの堅牢性を高める。 | 最新版 |
| **Biome** | フォーマッターおよびリンター。コード品質を統一する。CIに組み込み、警告を修正する。 | 最新版 |

### 5.2. フロントエンド (`pkgs/frontend`)

| 技術 | 概要 | バージョン |
| :--- | :--- | :--- |
| **Next.js** | Reactフレームワーク。App Routerを採用し、PWA対応も行う。 | 最新版 |
| **Tailwind CSS** | CSSフレームワーク。効率的なUIスタイリングを実現する。 | 最新版 |
| **Shadcn/UI** | UIコンポーネントライブラリ。高品質なUIを迅速に構築する。 | 最新版 |
| **wagmi** | React Hooks for Ethereum。ウォレット接続やコントラクト対話を容易にする。 | 最新版 |
| **RainbowKit** | ウォレット接続用のUIライブラリ。優れたUXを提供する。 | 最新版 |
| **viem** | TypeScript Interface for Ethereum。wagmiのコア依存関係であり、軽量で型安全なEthereumとの対話を実現する。 | 最新版 |

### 5.3. スマートコントラクト (`pkgs/contract`)

| 技術 | 概要 | バージョン / 目標 |
| :--- | :--- | :--- |
| **Solidity** | スマートコントラクト開発言語。 | 0.8.20 |
| **Hardhat** | スマートコントラクト開発環境。コンパイル、テスト、デプロイを管理する。 | 最新版 |
| **OpenZeppelin Contracts** | セキュアなスマートコントラクトライブラリ。ERC20などの標準実装に利用する。 | 最新版 |
| **viem** | テストコードやデプロイスクリプトで、型安全なコントラクト対話を実現する。 | 最新版 |
| **Hardhat Gas Reporter** | トランザクションのガス消費量をレポートする。ガス最適化に役立てる。 | 最新版 |
| **Solhint** | Solidityの静的解析ツール。コードの品質とセキュリティを向上させる。CIに組み込む。 | 最新版 |
| **テストカバレッジ** | コード品質の指標。 | 95%以上を目指す。 |

## 6. 開発ネットワーク

- **ネットワーク:** Sepolia Testnet
- **RPCエンドポイント:** Alchemy

開発者は、AlchemyのAPIキーと、SepoliaETHを保有するウォレットの秘密鍵を環境変数に設定する必要があります。
