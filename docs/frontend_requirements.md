# NFTマーケットプレイス フロントエンド要件定義書 (v3)

## 1. 概要

本ドキュメントは、NFTマーケットプレイスのフロントエンドアプリケーションに関する要件を定義する。
このアプリケーションは、ブロックチェーン上のスマートコントラクトと連携し、ユーザーがNFTの作成、出品、購入、閲覧を行えるWebアプリケーションである。
開発にあたっては、`.github/instructions/frontend.instructions.md` に記載されたルールを遵守する。

## 2. プロジェクトの目的

- **UXの革新:** Account Abstraction (AA) を活用し、従来のWeb3アプリケーション特有の複雑さ（ガス代の支払い、ウォレット管理など）を排除する。ソーシャルログインやEメールログインを可能にし、Web2アプリケーションのようなシームレスなユーザー体験を提供する。
- **透明性と信頼性:** スマートコントラクトの機能を最大限に活用し、透明性と信頼性の高い取引プラットフォームを構築する。
- **高い開発効率と保守性:** モダンな技術スタックと定義された開発ルールに基づき、効率的で保守性の高いアプリケーションを実現する。

## 3. 機能要件

### 3.1. ユーザー認証

| 機能ID | 機能名 | 概要 |
| :--- | :--- | :--- |
| FE-001 | **Privyによるログイン** | `Privy` を利用して、Eメールやソーシャルアカウント（Google, Xなど）でのログイン機能を提供する。初回ログイン時に、各ユーザー専用のスマートコントラクトウォレット（`Biconomy` を利用）がバックグラウンドで自動生成される。 |

### 3.2. NFT一覧・詳細

| 機能ID | 機能名 | 概要 |
| :--- | :--- | :--- |
| FE-002 | NFT一覧表示 | マーケットプレイスに出品されているNFTを一覧で表示する。各NFTには画像、名前、価格が表示される。 |
| FE-003 | NFT詳細表示 | 一覧からNFTを選択すると、その詳細ページに遷移する。画像、名前、説明、価格、出品者、オーナー、プロパティ、取引履歴などを表示する。 |
| FE-004 | 検索機能 | キーワードでNFTを検索できる。 |
| FE-005 | ソート・フィルタリング | 価格、作成日時などでNFTを並び替え・絞り込みできる。（※カテゴリなど高度なフィルタリングは、The Graph等のインデクシングサービスの導入を要検討） |

### 3.3. NFT作成・管理

| 機能ID | 機能名 | 概要 |
| :--- | :--- | :--- |
| FE-006 | NFT作成 | ユーザーは画像、名前、説明、プロパティなどを入力して新しいNFTを作成できる。**トランザクション手数料（ガス代）はBiconomyのPaymaster機能により不要。** <br><br> **プロセス詳細:** <br> 1. ユーザーが入力した情報からメタデータJSONを生成する。 <br> 2. 画像ファイルとメタデータJSONをIPFS等の分散ストレージにアップロードする。 <br> 3. アップロードして得られたURI (tokenURI) を用いて、スマートコントラクトの`mintNFT`関数を呼び出す。 |
| FE-007 | NFT出品 | ユーザーは所有しているNFTをマーケットプレイスに出品できる。出品時に販売価格を設定する。**この操作のトランザクション手数料（ガス代）も不要。** |
| FE-008 | 出品キャンセル | ユーザーは出品中のNFTを取り下げることができる。**この操作のトランザクション手数料（ガス代）も不要。** |

### 3.4. NFT取引

| 機能ID | 機能名 | 概要 |
| :--- | :--- | :--- |
| FE-009 | NFT購入 | ユーザーは出品されているNFTを購入できる。**トランザクション手数料（ガス代）はBiconomyを利用し不要。** (※NFTの購入代金は別途必要) |
| FE-010 | オファー作成 | ユーザーは出品されているNFTに対して購入希望額を提示（オファー）できる。**この操作のトランザクション手数料（ガス代）も不要。** (※オファー金額は別途必要) |
| FE-011 | オファー承諾 | NFTの所有者は、自身のNFTへのオファーを承諾し、売買を成立させることができる。**この操作のトランザクション手数料（ガス代）も不要。** |
| FE-012 | オファーキャンセル | ユーザーは自身が行ったオファーを取り下げることができる。**この操作のトランザクション手数料（ガス代）も不要。** |

### 3.5. マイページ

| 機能ID | 機能名 | 概要 |
| :--- | :--- | :--- |
| FE-013 | 所有NFT一覧 | ユーザーが所有しているNFTを一覧で表示する。 |
| FE-014 | 出品中NFT一覧 | ユーザーが出品しているNFTを一覧で表示する。 |
| FE-015 | 取引履歴表示 | ユーザーの過去のNFT取引（購入・売却）履歴を表示する。 |
| FE-016 | プロフィール編集 | ユーザー名やプロフィール画像を設定できる。**これらのデータはオフチェーン（Privyのメタデータ機能または別途用意するDB）に保存される。** |

## 4. 非機能要件

### 4.1. パフォーマンス

- ページの読み込み時間は3秒以内を目指す。
- 画像などの静的リソースは最適化し、高速に表示する。
- ブロックチェーンとの通信は非同期で行い、ユーザーの操作を妨げないようにする。

### 4.2. ユーザビリティ

- **Web2ライクな体験:** Account Abstractionにより、ユーザーはガス代やウォレットの署名といったWeb3特有の操作を意識することなく、サービスを利用できる。
- **直感的なUI/UX:** `shadcn/ui` をベースにした、直感的でわかりやすいUIを設計する。
- **レスポンシブデザイン:** PC、タブレット、スマートフォンなど、様々なデバイスで快適に利用できるようにする。
- **明確なフィードバック:** 
  - トランザクション実行時には、ローディング表示や進捗表示を適切に行う。
  - **トランザクションの状態遷移の可視化:**
    - **送信時:** トースト通知で「処理を開始しました」と表示し、ユーザーが任意で確認できるようトランザクションハッシュへのリンクを提示する。
    - **処理中:** マイページの取引履歴などで、該当トランザクションが「処理中」であることを示すインジケータを表示する。
    - **完了時:** トランザクションが成功または失敗した際に、再度トースト通知で結果を知らせる。
    - **失敗時:** 「他のユーザーが先に購入しました」「残高が不足しています」など、可能な限り原因が分かりやすいエラーメッセージを表示する。
- エラー発生時には、ユーザーに分かりやすいメッセージを表示する。

### 4.3. セキュリティ

- XSS（クロスサイトスクリプティング）やCSRF（クロスサイトリクエストフォージェリ）などの一般的なWeb脆弱性対策を講じる。
- スマートコントラクトとのやり取りにおいて、意図しないトランザクションが発生しないように設計する。
- ユーザーの認証情報は `Privy` によって安全に管理され、フロントエンドで秘密鍵を保持しない。

### 4.4. 互換性

- 主要なWebブラウザ（Google Chrome, Firefox, Safari, Microsoft Edge）の最新バージョンに対応する。

## 5. 技術スタック

| 分類 | 技術 | 概要 |
| :--- | :--- | :--- |
| フレームワーク | Next.js (App Router) | Reactベースのフレームワーク。PWA対応も行う。 |
| UIライブラリ | Tailwind CSS | ユーティリティファーストのCSSフレームワーク。 |
| UIコンポーネント | Shadcn UI | Tailwind CSSをベースにした再利用可能なUIコンポーネントライブラリ。 |
| 言語 | TypeScript | 静的型付けにより、コードの堅牢性と開発効率を向上させる。 |
| ユーザー認証 | Privy | Eメールやソーシャルログインを提供し、エンベデッドウォレットを管理する。 |
| Account Abstraction | Biconomy | スマートアカウントの作成と、Paymasterを利用したガスレストランザクションを実現する。 |
| ブロックチェーン通信 | viem / ethers.js | スマートコントラクトとの対話を行うためのライブラリ。 |
| **分散ストレージ** | **IPFS (Pinata, NFT.Storageなど)** | **NFTの画像やメタデータを永続的に保存するためのストレージ。** |
| **インデクシング** | **The Graph (検討)** | **高度なソート・フィルタリング機能を実現するために、The Graphのようなインデクシングサービスの利用を検討する。** |
| 状態管理 | Zustand / Jotai | シンプルで軽量な状態管理ライブラリ。 |
| テスト | Vitest / React Testing Library | 高速なテストフレームワークとReactコンポーネントのテストライブラリ。 |
| フォーマッター/Linter | Biome | 高速なフォーマッターとLinter。コード品質を維持する。 |

## 6. 画面設計（ワイヤーフレーム）

### 6.1. 全体のデザインコンセプト

- **テイスト:** モダン、クリーン、かつ直感的なUIを目指します。`shadcn/ui` の `New York` スタイルをベースに、洗練された印象を与えます。
- **カラーパレット:** `neutral` を基調とした落ち着いた配色を基本とし、重要なアクション（購入ボタン、作成ボタンなど）にはアクセントカラーを用いて視認性を高めます。
- **タイポグラフィ:** 可読性の高いサンセリフ体のフォント（Interなど）を採用し、情報階層を明確に伝えます。
- **レイアウト:** レスポンシブデザインを徹底し、PCからスマートフォンまで一貫したユーザー体験を提供します。NFTの一覧表示には、情報を整理しやすいカードベースのグリッドレイアウトを採用します。

### 6.2. 共通コンポーネント

- **ヘッダー:**
  - **ロゴ:** サイトのブランディングを示すロゴを左端に配置。クリックするとトップページに遷移します。
  - **ナビゲーション:** 「見つける（Explore）」、「作成する（Create）」など、主要機能へのリンクを配置します。
  - **検索バー:** NFTをキーワードで検索するためのグローバルな検索バーを設置します。
  - **ユーザー認証:**
    - **未ログイン時:** 「ログイン」ボタンを配置。クリックするとPrivyのログインモーダルが表示されます。
    - **ログイン時:** ユーザーのプロフィールアイコンとアドレスを表示。クリックするとドロップダウンメニューが開き、「マイページ」「ログアウト」へのリンクが表示されます。
- **フッター:**
  - **サイトマップ:** 利用規約、プライバシーポリシーなどへのリンクを配置します。
  - **ソーシャルリンク:** プロジェクトのX（旧Twitter）やDiscordなど、コミュニティへのリンクをアイコンで表示します。
  - **コピーライト:** `© 2025 NFT Marketplace.` のようなコピーライト表記を記載します。

### 6.3. 各画面の詳細

- **トップページ（NFT一覧）:**
  - **機能:**
    - 出品中のNFTをグリッド形式で一覧表示します。
    - 無限スクロールまたはページネーションを実装し、多数のNFTを閲覧できるようにします。
    - 価格、新着順、人気順などで並び替えるソート機能を提供します。
    - カテゴリや属性によるフィルタリング機能を提供します。
  - **動線:**
    - 各NFTカードをクリックすると、そのNFTの詳細ページに遷移します。
    - ヘッダーの「作成する」ボタンからNFT作成ページに遷移します。

- **NFT詳細ページ:**
  - **機能:**
    - NFTの画像または動画を大きく表示します。
    - NFTの名称、説明、現在の所有者、作成者を表示します。
    - 「購入する」ボタンと「オファーする」ボタンを配置します。
    - タブ形式で「属性（Properties）」、「オファー履歴」、「取引履歴」などの詳細情報を切り替えて表示します。
  - **動線:**
    - 「購入する」ボタンをクリックすると、確認モーダルが表示され、承認すると購入が実行されます。**トランザクション手数料（ガス代）は不要だが、NFT購入代金は別途必要であることが明記される。**
    - 「オファーする」ボタンをクリックすると、オファー金額を入力するモーダルが表示され、承認するとオファーが実行される。**トランザクション手数料（ガス代）は不要だが、オファー金額はウォレットからロックされる（または同等の処理が行われる）ことが明記される。**

- **NFT作成ページ:**
  - **機能:**
    - 画像や動画ファイルをアップロードするインターフェースを提供します。
    - NFTの「名前」「説明」「属性（プロパティ）」を入力するフォームを設置します。
    - 入力内容をリアルタイムでプレビューできる機能を設けます。
    - 「作成する」ボタンを押すと、入力内容に基づいてNFTが発行されます。
  - **動線:**
    - 全ての必須項目を入力後、「作成する」ボタンがアクティブになります。
    - ボタンをクリックすると、**トランザクション手数料（ガス代）が不要**でNFT発行トランザクションが実行され、成功後は作成したNFTの詳細ページにリダイレクトされます。

- **マイページ:**
  - **機能:**
    - ユーザーのプロフィール情報（アイコン、名前）を表示・編集する機能を提供します。
    - 「所有NFT」「出品中NFT」「取引履歴」「受けたオファー」を切り替えるタブを設置します。
    - **所有NFTタブ:** ユーザーが所有するNFTを一覧表示します。ここから出品操作を行えます。
    - **出品中NFTタブ:** ユーザーが出品中のNFTを一覧表示します。出品のキャンセルや**価格変更**が可能です。(※価格変更は、現在のコントラクト仕様上「出品キャンセル→再出品」のフローとなる)
  - **動線:**
    - 「所有NFT」タブでNFTを選択し、「出品する」ボタンを押すと、価格設定モーダルが表示され、承認すると**トランザクション手数料（ガス代）が不要**で出品トランザクションが実行されます。
    - 「受けたオファー」タブでオファーを選択し、「承諾する」ボタンを押すと、**トランザクション手数料（ガス代）が不要**で売買トランザクションが実行されます。

- **ログインモーダル (Privy):**
  - **機能:** Privyが提供するUIをそのまま利用します。Eメール、Google、Xなどのソーシャルログインオプションを表示します。
  - **動線:** ヘッダーの「ログイン」ボタン、または認証が必要なアクション（購入、作成など）を実行しようとした際にモーダルが表示されます。

## 7. スマートコントラクトの実装

現在 `pkgs/contract/contracts` 配下に実装されているスマートコントラクトの主な機能は以下の通りです。

### NFTContract.sol (`ERC721`)

- **NFT発行 (Mint):**
    - `mintNFT`: 手数料を支払うことで、新しいNFTを発行します。
    - 発行時にトークンURIとロイヤリティ情報を設定します。
    - NFTの作成者を記録します。
- **ロイヤリティ (ERC2981):**
    - `updateTokenRoyalty`: NFTの作成者またはコントラクトオーナーが、トークンごとのロイヤリティ設定を更新できます。
- **管理機能 (オーナー限定):**
    - `updateMintFee`: NFTの発行手数料を変更します。
    - `withdrawFees`: コントラクトに蓄積された手数料を引き出します。
    - `pause`/`unpause`: コントラクトの主要な機能（転送など）を一時停止・再開します。
- **情報取得:**
    - `getCreator`: 指定したトークンIDの作成者アドレスを取得します。
    - `tokenURI`: トークンのメタデータURIを取得します。

### NFTMarketplace.sol

- **固定価格での出品・購入:**
    - `listNFT`: 所有するNFTを固定価格で出品します。
    - `buyNFT`: 出品されているNFTを指定された価格で購入します。
    - `cancelListing`: 出品を取り下げます。
- **オファー機能:**
    - `makeOffer`: NFTに対して希望額でオファーを提示します。
    - `acceptOffer`: NFTの所有者が提示されたオファーを承諾します。
    - `cancelOffer`: 提示したオファーを取り下げます。
- **手数料とロイヤリティの分配:**
    - NFTの売買成立時（`buyNFT`, `acceptOffer`）に、売上からマーケットプレイス手数料と、NFTに設定されたロイヤリティを自動的に計算し、それぞれ徴収・分配します。
- **販売履歴:**
    - `salesHistory`: 売買が成立した取引の履歴を記録します。
- **管理機能 (オーナー限定):**
    - `updateMarketplaceFee`: マーケットプレイスの手数料率を変更します。
    - `withdrawFees`: コントラクトに蓄積されたマーケットプレイス手数料を引き出します。
    - `pause`/`unpause`: マーケットプレイスの主要な機能（出品、購入など）を一時停止・再開します。
- **情報取得:**
    - `listings`: 出品情報を取得します。
    - `offers`: オファー情報を取得します。
    - `getSalesHistoryCount`: 販売履歴の総数を取得します。

## 8. 開発スコープ

### 8.1. スコープ内

本要件定義書に記載されたすべての機能。

### 8.2. スコープ外

- **管理者向け機能:** スマートコントラクトのオーナー（管理者）が手数料の変更やコントラクトの一時停止などを行うための専用画面は、本開発のスコープ外とする。これらの操作は、EtherscanやHardhatスクリプトなどを用いて手動で実行することを想定する。

## 9. その他

- 本要件定義書は、開発の進捗や仕様変更に応じて随時更新されるものとする。
- ディレクトリ構成や実装の詳細は `.github/instructions/frontend.instructions.md` の規約に従う。
