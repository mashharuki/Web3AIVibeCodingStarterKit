# DEX Smart Contract Test Suite

## 概要
このディレクトリには、DEX（分散型取引所）スマートコントラクトの包括的なテストスイートが含まれています。

## テストファイル一覧

### 1. DexFactory.test.ts
**目的**: ペア作成・管理を行うファクトリーコントラクトのテスト

**テストケース**:
- ✅ デプロイメントと初期化
- ✅ ペア作成機能（成功・失敗ケース）
- ✅ 重複ペア作成の防止
- ✅ 手数料設定機能
- ✅ 権限管理

### 2. TokenA.test.ts
**目的**: フォーセット機能付きERC20テストトークンのテスト

**テストケース**:
- ✅ ERC20基本機能
- ✅ フォーセット機能（24時間クールダウン）
- ✅ クールダウン制限の確認
- ✅ 複数ユーザーでの同時利用
- ✅ ReentrancyGuard保護

### 3. DexPair.test.ts
**目的**: AMM流動性プールの核となるペアコントラクトのテスト

**テストケース**:
- ✅ 流動性提供（初回・追加）
- ✅ 流動性削除
- ✅ スワップ機能
- ✅ 最小流動性の処理
- ✅ 価格オラクル機能
- ✅ 手数料計算

### 4. DexRouter.test.ts
**目的**: ユーザー向けインターフェースを提供するルーターコントラクトのテスト

**テストケース**:
- ✅ 流動性追加・削除
- ✅ スワップ機能（正確な入力量/出力量）
- ✅ スリッページ保護
- ✅ 期限制御
- ✅ パス検証
- ✅ ユーティリティ関数

### 5. Integration.test.ts
**目的**: 全コントラクトを統合した実際のDEXワークフローのテスト

**テストケース**:
- ✅ 完全なDEXワークフロー（流動性提供→スワップ→流動性削除）
- ✅ 複数回スワップでの価格変動
- ✅ 手数料分配の確認
- ✅ 流動性不足時の動作
- ✅ エッジケースの処理

## テスト実行方法

```bash
# 全テストの実行
pnpm test

# 特定のテストファイルの実行
pnpm test test/DexFactory.test.ts
pnpm test test/TokenA.test.ts
pnpm test test/DexPair.test.ts
pnpm test test/DexRouter.test.ts
pnpm test test/Integration.test.ts

# テストカバレッジの確認
pnpm test:coverage

# 特定のテストケースの実行
pnpm test -- --grep "流動性提供"
```

## テストの特徴

### セキュリティテスト
- ReentrancyGuard保護の確認
- 権限管理の検証
- エラーハンドリングの確認
- 不正入力に対する堅牢性

### 経済的ロジックテスト
- AMM数式の正確性
- 手数料計算の確認
- スリッページ保護
- 価格オラクルの動作

### ガス効率性テスト
- 最適化されたコントラクト実装
- ガス使用量の監視
- 効率的なバッチ処理

### エッジケーステスト
- 最小/最大値での動作
- 境界条件の処理
- 異常系での安全性

## テストデータ

### 使用トークン
- **TokenA (TKA)**: フォーセット機能付きテストトークン
- **TokenB (TKB)**: フォーセット機能付きテストトークン

### テスト用アカウント
- **owner**: コントラクトオーナー
- **liquidity_provider**: 流動性提供者
- **trader1, trader2**: トレーダー
- **user1, user2**: 一般ユーザー

### テスト環境
- **Network**: Hardhat localhost
- **Compiler**: Solidity 0.8.30
- **Framework**: Hardhat + Ethers.js + Chai

## 継続的改善

このテストスイートは以下の観点で継続的に改善されています：

1. **カバレッジの向上**: 新機能追加時のテストケース拡充
2. **性能テスト**: ガス使用量とトランザクション効率の最適化
3. **セキュリティテスト**: 新たな攻撃ベクトルに対する防御確認
4. **実用性テスト**: 実際の使用パターンを模したシナリオテスト

## 注意事項

- テストは開発環境でのみ実行してください
- 実際のトークンやメインネットでは使用しないでください
- テスト実行前に最新のコンパイルを行ってください (`pnpm compile`)
